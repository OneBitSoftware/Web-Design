<head>

</head>

<body>

</body>
<script src="../js/moment.js"></script>
<script src="../js/jquery.min.js"></script>
<script src="../js/handlebars-v4.0.11.js"></script>

<script type="text/javascript">
    function loadPage(href) {
        let xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", href, false);
        xmlhttp.send();
        return xmlhttp.responseText;
    }
</script>
<script>
    let requestedUrl = window.location.search;

    function saveUrlInLocalStorage(url) {
        if (url.includes('page=')) {
            let positionOfPageQuery = url.indexOf('page=');
            localStorage["filtration"] = url.substr(0, positionOfPageQuery - 1);
        }
        else {
            localStorage["filtration"] = url;
        }
    }

    saveUrlInLocalStorage(requestedUrl);

</script>
<script>
    let headSource = loadPage('../head.html');
    let headTemplate = Handlebars.compile(headSource);
    let headContext = {title: "LockChain Marketplace"};

    let headerSource = loadPage('../header.html');
    let headerTemplate = Handlebars.compile(headerSource);

    let breadcrumbSource = loadPage('breadcrumb.html');
    let breadcrumbTemplate = Handlebars.compile(breadcrumbSource);

    let filtersSource = loadPage('filters.html');
    let filtersTemplate = Handlebars.compile(filtersSource);

    let footerSource = loadPage('../footer.html');
    let footerTemplate = Handlebars.compile(footerSource);
    var locRate = parseFloat($("#loc-rate").text())


    let compiledTemplate = headerTemplate() + breadcrumbTemplate() + filtersTemplate() + footerTemplate();

    $('head').html(headTemplate(headContext));

    $('body')
        .append(headerTemplate())
        .append(breadcrumbTemplate())
        .append(
            $('<section>')
                .attr('id', 'hotel-box')
                .append(
                    $('<div>').addClass('container')
                        .append(
                            $('<div>').addClass('row')
                                .append(
                                    $('<div>').addClass('col-md-3')
                                )
                                .append(
                                    $('<div>').addClass('col-md-9')
                                        .append(
                                            $('<div>').addClass('list-hotel-box').attr('id', 'list-hotel-box')
                                        )
                                )
                        )
                ))
        .append(footerTemplate());

    $('#hotel-box .col-md-3').append(filtersTemplate()).promise().then(() => {
        $('#filter-button').click(() => {
            var params = getParameters();
            window.location.href = frontEndHost + "Listings/listings.html?" + params;
        });

        function generatePropertyTypeOrAmenityTemplate(item) {
            let template = $('<label>').addClass('filter-check-label')
                .append(
                    $('<span>').addClass('filter-check')
                )
                .append(
                    $('<span>').addClass('filter-check-text').text(item.name)
                )
                .append(
                    $('<span>').addClass('filter-check-count').text(item.count)
                );

            return template;
        }

        let locationPropertyTypes = $('#filter-propertyType');
        var [apiHost, frontEndHost] = config();
        $.get(apiHost + 'api/property_types?projection=property_type', function (data) {
            data.content.forEach(propertyType => {
                let propertyTypeTemplate = generatePropertyTypeOrAmenityTemplate(propertyType);
                locationPropertyTypes.append(propertyTypeTemplate);
            });
        }).then(() => {
            locationPropertyTypes.append($('<div>').addClass('clearfix'));
            $('#filter-type .filter-check').click(propertyTypeClickHandler);
        });

        let locationAmenities = $('#filter-amenity');

        $.get(apiHost + 'api/amenities?projection=amenity_aggregation', function (data) {
            data.content.forEach(amenity => {
                let amenityTemplate = generatePropertyTypeOrAmenityTemplate(amenity);
                locationAmenities.append(amenityTemplate);
            })
        }).then(() => {
            $('#filter-amenities .filter-check').click(propertyAmenitiesClickHandler);
            locationAmenities.append($('<div>').addClass('clearfix'));
        });
    });
</script>
<script>
    $('.fancybox').fancybox({
        'speedIn': 600,
        'speedOut': 200,
        'onComplete': function () {
            $("#fancybox-wrap").css({'top': '100px!important', 'left': '0'});
        }
    });
    $('.input-daterange input').each(function () {
        $(this).datepicker('clearDates');
    });

    $("#price-slider").slider({});
    $("#distance-slider").slider({});

    $('.filter-room-facility-more-href').on('click', function (e) {
        e.preventDefault();
        $('.filter-room-facility-more').toggle();
        $('.filter-room-facility-more-href').css('display', 'none');
    });

    $('.filter-room-facility-hide-href').on('click', function (e) {
        e.preventDefault();
        $('.filter-room-facility-more').toggle();
        $('.filter-room-facility-more-href').css('display', 'block');
    });

    $('.filter-facility-more-href').on('click', function (e) {
        e.preventDefault();
        $('.filter-facility-more').toggle();
        $('.filter-facility-more-href').css('display', 'none');
    });

    $('.filter-facility-hide-href').on('click', function (e) {
        e.preventDefault();
        $('.filter-facility-more').toggle();
        $('.filter-facility-more-href').css('display', 'block');
    })
</script>
<script>
    let propertyStars = new Set();
    let propertyTypes = new Set();
    let propertyAmenities = new Set();

    let propertyTypeQueryString = '';
    let propertyStarsQueryString = '';
    let propertyAmenitiesQueryString = '';

    let minPrice, maxPrice;

    $(document).ready(function () {
        $('.filter-stars span').click(propertyStarsClickHandler);
    });


    let priceSliderElement = $('#price-slider');

    function propertyStarsClickHandler(eventData) {
        let clickedSpanElement = $(eventData.target);
        clickedSpanElement.toggleClass('active');
        let spanText = clickedSpanElement.text();
        if (propertyStars.has(spanText)) {
            propertyStars.delete(spanText);
        } else {
            propertyStars.add(spanText);
        }
    }

    function propertyTypeClickHandler(eventData) {
        let clickedFilterGroupElement = $(eventData.target).parent();
        clickedFilterGroupElement.toggleClass('active');
        let filterCheckText = clickedFilterGroupElement.children('.filter-check-text').text();
        if (propertyTypes.has(filterCheckText)) {
            propertyTypes.delete(filterCheckText);
        } else {
            propertyTypes.add(filterCheckText);
        }
    }


    function propertyAmenitiesClickHandler(eventData) {
        let clickedFilterGroupElement = $(eventData.target).parent();
        clickedFilterGroupElement.toggleClass('active');
        let filterCheckText = clickedFilterGroupElement.children('.filter-check-text').text();
        if (propertyAmenities.has(filterCheckText)) {
            propertyAmenities.delete(filterCheckText);
        } else {
            propertyAmenities.add(filterCheckText);
        }
    }

    function getPropertyStarsQueryString() {
        let queryString = '';

        propertyStars.forEach(element => {
            queryString += element + ',';
        });

        return queryString.substr(0, queryString.length - 1);
    }

    function getPropertyTypeQueryString() {
        let queryString = '';

        propertyTypes.forEach(element => {
            queryString += element + ',';
        });

        return queryString.substr(0, queryString.length - 1);
    }

    function getPropertyAmenitiesQueryString() {
        let queryString = '';

        propertyAmenities.forEach(element => {
            queryString += element + ',';
        });

        return queryString.substr(0, queryString.length - 1);
    }

    function getParameters() {
        [minPrice, maxPrice] = priceSliderElement.val().split(',').map(Number);

        var parameters = '';

        propertyTypeQueryString = getPropertyTypeQueryString();
        propertyStarsQueryString = getPropertyStarsQueryString();
        propertyAmenitiesQueryString = getPropertyAmenitiesQueryString();
        parameters += localStorage["filtration"].indexOf("?") === 0 ? localStorage["filtration"].replace("?", "") : localStorage["filtration"];
        // parameters += `projection=${projection}`;
        parameters += `&priceMin=${minPrice}`;
        parameters += `&priceMax=${maxPrice}`;
        let paramsObj = JSON.parse('{"' + decodeURI(parameters).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g, '":"') + '"}')

        let types = "";
        for (let span of $("#filter-type").find(".active")) {
            let spanText = $(span).find(".filter-check-text");
            types += spanText.text() + ",";
        }
        types = types.substr(0, types.length - 1);

        if (!("propertyTypes" in paramsObj) && types.length > 0) {
            paramsObj["propertyTypes"] = types;
        } else if ("propertyTypes" in paramsObj && types.length > 0) {
            paramsObj["propertyTypes"] += "," + types;
        }

        let amenities = "";
        for (let span of $("#filter-amenities").find(".active")) {
            let spanText = $(span).find(".filter-check-text");
            amenities += spanText.text() + ",";
        }
        amenities = amenities.substr(0, amenities.length - 1);

        if (!("amenities" in paramsObj) && amenities.length > 0) {
            paramsObj["amenities"] = amenities;
        } else if ("amenities" in paramsObj && amenities.length > 0) {
            paramsObj["amenities"] += "," + amenities;
        }

        let stars = "";
        for (let span of $("#filter-star").find(".active")) {
            let spanText = $(span).text();
            stars += spanText + ",";
        }
        stars = stars.substr(0, stars.length - 1);

        if (!("propertyStars" in paramsObj) && stars.length > 0) {
            paramsObj["propertyStars"] = stars;
        } else if ("propertyStars" in paramsObj && stars.length > 0) {
            paramsObj["propertyStars"] = stars;
        }

        let testParams = "";
        for (var key in paramsObj) {
            testParams += key + "=" + paramsObj[key] + "&"
        }
        testParams = testParams.substr(0, testParams.length - 1);

        //
        // if (propertyTypes.length > 0 || types.length > 0) {
        //     parameters += `&propertyTypes=${propertyTypeQueryString}`;
        //     if (propertyTypes.length > 0) parameters += ",";
        //     parameters += types;
        // }
        // if (propertyStars.length > 0) {
        //     parameters += `&propertyStars=${propertyStarsQueryString}`;
        // }
        // if (propertyAmenities.length > 0) {
        //     parameters += `&propertyAmenities=${propertyAmenitiesQueryString}`;
        // }

        testParams = testParams.split(' ').join('%20');
        return testParams;
    }

    function generateEndPoint() {
        var path = 'api/listings/search/getAllByFilter?';
        var projection = 'listings';
        var parameters = getParameters();

        var [apiHost, frontEndHost] = config();
        let endPoint = apiHost + path + parameters + '&projection=listings&sort=defailyDailyPrice,asc';
        let page = 1;
        if (window.location.search.includes('page=')) {
            let positionOfPageQuery = window.location.search.indexOf('page=');
            page = parseInt(window.location.search.substr(positionOfPageQuery + 5, window.location.search.length));
        }

        endPoint += "&page=" + page;
        return endPoint;
    }

    function search() {
        let endPoints = generateEndPoint();
        getListings(endPoint);
    }

    function generatePaginationTemplate(data) {
        let out = "";

        for (let i = 1; i <= data.page.totalPages; i++) {
            if (i === localStorage["currentPageNumber"]) {
                out += "<li><a class='active' href='" + localStorage["filtration"] + '&page=' + i + "'>" + i + "</a></li>";
            } else {
                out += "<li><a href='" + localStorage["filtration"] + '&page=' + i + "'>" + i + "</a></li>";
            }
        }

        return out;
    }

    function getListings(endPoint) {
        console.log("---");
        console.log(endPoint);
        $.getJSON(endPoint, (data, status, xhr) => {

            if (status === 'success') {
                let insertionRow = $('#list-hotel-box');

                if (!data.page.totalElements || data.page.totalElements == 0) {
                    insertionRow.append($('<div>').addClass('list-hotel')
                        .html("<h1 style='text-align: center; vertical-align: middle'>No results found</h1>"));
                } else {
                    data.content.forEach(listing => {

                        if (!localStorage.getItem("fromCurrency")) {
                            localStorage.setItem("fromCurrency", "USD");
                            localStorage.setItem("sign", "$");
                        }

                        let listingTemplate = generateListingTemplate(listing);
                        insertionRow.append(listingTemplate);
                    });
                }
            }
        }).then((data) => {
            $('#list-hotel-box').append(
                $('<div>').addClass('pagination-box')
                    .append(
                        $('<ul>').addClass('pagination')
                            .append(
                                generatePaginationTemplate(data)
                            )
                    )
            )
        });
    }

    let page = 1;
    if (window.location.search.includes('page=')) {
        let positionOfPageQuery = window.location.search.indexOf('page=');
        page = parseInt(window.location.search.substr(positionOfPageQuery + 5, window.location.search.length));
    }
    console.log(page);
    var [apiHost, frontEndHost] = config();
    getListings(
        apiHost +
        'api/listings/search/getAllByFilter' +
        localStorage["filtration"] +
        "&projection=listings" +
        '&page=' +
        page
    );
</script>
<script>
    function generateListingImageSubTemplate(listing) {
        let htmlItems = "";

        $.each(listing.pictures, function (i, item) {
            if (i === 0) {
                htmlItems += "<div class='item active'><a class='fancybox' data-fancybox-group='group-" + listing.id + "' href='" + item.original + "'><img src='" + item.thumbnail + "' /></a></div>";
            } else {
                htmlItems += "<div class='item'><a class='fancybox' data-fancybox-group='group-'" + listing.id + "href='" + item.original + "'><img src='" + item.thumbnail + "' /></a></div>";
            }
        });

        let listingPictures = $('<div>')
            .addClass('list-image')
            .append(
                $('<div>')
                    .addClass('carousel slide')
                    .attr('data-ride', 'carousel')
                    .attr('id', 'myCarousel-' + listing.id)
                    .append(
                        $('<div>').addClass('carousel-inner').append(
                            htmlItems +
                            '<a class="left-carousel" href="#myCarousel-' + listing.id + '" data-slide="prev"></a>' +
                            '<a class="right-carousel" href="#myCarousel-' + listing.id + '" data-slide="next"></a>'
                        )
                    )
            );

        return listingPictures;
    }

    function generateListingContentSubTemplate(listing) {
        let listingContent = $('<div>').addClass('list-content')
            .append(
                $('<h2>')
                    .text(listing.name)
            )
            .append(
                $('<div>')
                    .addClass('list-hotel-rating')
                    .append(
                        $('<div>')
                            .addClass('list-hotel-rating-count')
                            .text(Math.round(listing["averageRating"] * 100) / 100)
                    )
                    .append(
                        $('<div>')
                            .addClass('list-hotel-rating-stars')
                            .append(
                                $('<span>')
                                    .addClass('full-star')
                            )
                            .append(
                                $('<span>')
                                    .addClass('full-star')
                            )
                            .append(
                                $('<span>')
                                    .addClass('full-star')
                            )
                            .append(
                                $('<span>')
                                    .addClass('full-star')
                            )
                            .append(
                                $('<span>')
                                    .addClass('empty-star')
                            )
                    )
                    .append(
                        $('<div>')
                            .addClass('list-hotel-rating-review')
                            .text(listing["reviewsCount"] + ' Reviews')
                    )
            )
            .append(
                $('<div>')
                    .addClass('clearfix')
            )
            .append(
                $('<div>')
                    .addClass('list-hotel-text')
                    .text(listing.description ? listing.description.substr(0, 300) : "")
            )
            .append(
                $('<div>')
                    .addClass('list-hotel-comfort')
                    .append(
                        $('<div>')
                            .addClass('icon-hotel-4')
                    )
                    .append(
                        $('<div>')
                            .addClass('icon-hotel-4')
                    )
                    .append(
                        $('<div>')
                            .addClass('icon-hotel-4')
                    )
                    .append(
                        $('<div>')
                            .addClass('icon-hotel-4')
                    )
            );

        return listingContent;
    }

    function generateListingPriceSubTemplate(listing) {
        var fromCurrency = localStorage.getItem("fromCurrency");
        var toCurrency = listing.currencyCode;
        var price = listing.defaultDailyPrice;
        var sign = localStorage.getItem("sign");
        if (locRate == null || isNaN(locRate)) {
            $.ajax({
                async: false,
                url: "https://lockchain.co/marketplace/internal_api/loc_price.php",
                success: function (data) {
                    $("#loc-rate").text(data.loc);
                    console.log(data);
                    locRate = parseFloat(data.loc);
                }
            });
        }

        listingPrice = $('<div>').addClass('list-price')
            .append(
                $('<div>')
                    .addClass('list-hotel-price-bgr')
                    .text('Price for 1 night')
            )
            .append(
                $('<div>')
                    .addClass('list-hotel-price-curency')
                    .text(sign + "" + Math.round(listing.prices[fromCurrency], 0))
            )
            .append(
                $('<div>')
                    .addClass('list-hotel-price-loc')
                    .text('(LOC ' + (listing.prices["EUR"] / locRate).toFixed(3) + ')')
            )
            .append(
                $('<a>')
                    .addClass('list-hotel-price-button btn btn-primary')
                    .attr('href', frontEndHost + 'Property/property.html?id=' + listing.id)
                    .text('Book now')
            );

        return listingPrice;
    }

    function generateListingTemplate(listing) {
        let listingTemplate = $('<div>').addClass('list-hotel')
            .append(
                generateListingImageSubTemplate(listing)
            )
            .append(
                generateListingContentSubTemplate(listing)
            )
            .append(
                generateListingPriceSubTemplate(listing)
            )
            .append(
                $('<div>')
                    .addClass('clearfix')
            );

        return listingTemplate;
    }
</script>